{% extends "page_layout.html" %}
{% load i18n %}

{% block title %} {% trans page_title %} - {{ block.super }} {% endblock title %}
{% block indexclass %} class="here" {% endblock indexclass %}

{% block head %}

    {{ block.super }}

    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}theme/gemecd.css" media="screen" />

    <!-- IE 8 Compatibility -->
    <!--<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7">-->

    <!-- Google resources -->
    <script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>

    <!-- leaflet resources -->
    <link rel="stylesheet" href="{{ src_folder }}src/Leaflet/dist/leaflet.css" />
    <script type="text/javascript" src="{{ src_folder }}src/Leaflet/dist/leaflet.js"></script>

    <!-- wax resources -->
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}theme/wax-controls.css" media="screen" >
    <script type='text/javascript' src='{{ src_folder }}src/L.Wax/L.Wax.js'></script>
    <script type="text/javascript" src="{{ src_folder }}src/wax/dist/wax.leaf.min.js"></script>
    <script type='text/javascript' src='{{ src_folder }}src/wax/ext/modestmaps.min.js'></script>
    <script type='text/javascript' src='{{ src_folder }}src/wax/dist/wax.mm.js'></script>

    <!-- jquery and other stuff -->
    <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>-->
    <!--<script type='text/javascript' src='{{ STATIC_URL }}jquery.min.js'></script>-->



    <!-- jQuery UI needed for iconic buttons in the filter bar -->
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" media="screen" />
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

    <!--<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}theme/exposure-legend.css" media="screen" /> -->


{% endblock head %}
<!--Google Analytics--><!--
<script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-20718690-2']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

</script>-->

{% block main %}

    {% if form.errors %}
        <div class="formerrorheader">Error in form</div>
    {%  endif %}

    {%  if editmode %}
        <form method="post" class="pageedit">{% csrf_token %}
            <table>
                {{ mainpageform.as_table }}
            </table>
            <input type="submit" value="Save" class="gobutton"/>
        </form>
    {%  endif %}

    {% if not form.errors and not editmode%}

    <div id="advancedfilterpanel">
       This is the advanced filter settings panel
        <a id="closebutton" href="javascript:alert('close');">close</a>
    </div>

<!--
    <div id="sidePanel-leg-hazard">
        <div id="panelContent-leg">
            <div class="map-legend-urban">
                <p>
                <div class='legend-title'>Legend<br/></div>
                <div class='legend-title-part'>Japan Hazard Model<br/>
                </div>
                <div class='legend-scale'>
                    <ul class='legend-labels'>
                        <li><span style='background:#E3E86A;'></span>0 - 20</li>
                        <li><span style='background:#EADA65;'></span>20 - 30</li>
                        <li><span style='background:#FFDC00;'></span>30 - 40</li>
                        <li><span style='background:#EFD462;'></span>40 - 50</li>
                        <li><span style='background:#F5CB5F;'></span>50 - 60</li>
                        <li><span style='background:#FFB858;'></span>60 - 70</li>
                        <li><span style='background:#FFAC53;'></span>70 - 80</li>
                        <li><span style='background:#FF8644;'></span>80 - 90</li>
                        <li><span style='background:#FF3D2F;'></span>90 - 100</li>
                        <li><span style='background:#FF0000;'></span>100 - 110</li>
                        <li><span style='background:#E60000;'></span>110 - 150</li>
                        <li><span style='background:#CC0D56;'></span>150 - 180</li>
                        <li><span style='background:#B80C4D;'></span>over 180</li>
                    </ul>
                </div>
            </div>
            <div class='legend-source'> Source: <a href="#">Source: The Japan models have been produced from a GEM implementation of the latest Japan PSHA model</a>
            </div> </p>

        </div>
        <div id="panelHandle-leg">
            <p>Legend</p>
        </div>
    </div>
-->

    {% block filterbar %}
        <div id="ecd-filterbar">

        <!--start filter bar-->
        <div id="filterbar">
            <div class="filterlabel">FILTER</div>
            <div id="filterbarleft">
                <form method="post">{% csrf_token %}
                    {{ filterbarform.as_p }}
                    <p><input id="id_filterbarform-submit" type="submit" value="apply"  title="Apply filters"/></p>
                    <div class="filterlabel"><a title="Click for advanced filtering options" id="advanced" href="javascript:alert('display options panel');">advanced</a></div>
                </form>
            </div>

            <div id="filterbarright">
                <form method="post">{% csrf_token %}
                    {{ eventquicklinksform.as_p }}
                    <!--<input type="submit" value=" &raquo; " class="gobutton" title="Quick link to details of event"/>-->
                </form>
            </div>
        </div>
        <!--end filter bar -->
    </div>
    {% endblock filterbar %}

    <div id="map" style="width: 100%;">

    </div>

    <!--[if lt IE 8]><div id="ie8message">You are using a version of Internet Explorer that cannot display this page - This page requires at least Internet Explorer 9 - or you can use Firefox, Chrome or Safari</div><![endif]-->

    <script type="text/javascript">

        //resize the main and map div
        $(document).ready(function() {
            var main_height = $(window).height() - $("#header-wrapper").height() - $("#footer").height();
            var map_height = $(window).height() - $("#header-wrapper").height() - $("#footer").height() - $("#tooltip").height() - $("#ecd-filterbar").height() - 10;
            $('#main').css("height",main_height + "px");
            $('#map').css("height",map_height + "px");
            map.invalidateSize(false);
        });

        $(document).ready(function() {
            $(window).resize(function(){
                var main_height = $(window).height() - $("#header-wrapper").height() - $("#footer").height();
                var map_height = $(window).height() - $("#header-wrapper").height() - $("#footer").height() - $("#tooltip").height()- $("#ecd-filterbar").height() - 10;
                $('#main').css("height",main_height + "px");
                $('#map').css("height",map_height + "px");
                map.invalidateSize(false);
            });
        });

        jQuery(document).ready(function($){
            // code to impose custom icons over the top of the checkboxes in the filter bar

            var firsttime = true;

            // buildings icon
            $('#id_filterbarform-buildings').button({
                text: true
            }).change(function() {
                        if (!firsttime) {$("#id_filterbarform-submit").addClass('highlight');};
                        if ($(this).is(':checked')){
                            $("#id_filterbarform-socioeconomic").prop("checked", false);
                            $("#id_filterbarform-socioeconomic").change();
                            $("#id_filterbarform-casualty").prop("checked", false);
                            $("#id_filterbarform-casualty").change();
                            $("#id_filterbarform-infrastructure").prop("checked", false);
                            $("#id_filterbarform-infrastructure").change();
                            $("#id_filterbarform-photos").prop("checked", false);
                            $("#id_filterbarform-photos").change();
                            $("#id_filterbarform-all").prop("checked", false);
                            $("#id_filterbarform-all").change();
                            $(this).button("option", {
                                icons: {primary: 'ui-buildings-checked' }
                            });
                        } else {
                            $(this).button("option", {
                                icons: {primary: 'ui-buildings-unchecked' }
                            });
                        }});


            // casualty icon
            $('#id_filterbarform-casualty').button({
                text: true
            }).change(function() {
                        if (!firsttime) {$("#id_filterbarform-submit").addClass('highlight');};
                        if ($(this).is(':checked')){
                            $("#id_filterbarform-buildings").prop("checked", false);
                            $("#id_filterbarform-buildings").change();
                            $("#id_filterbarform-socioeconomic").prop("checked", false);
                            $("#id_filterbarform-socioeconomic").change();
                            $("#id_filterbarform-infrastructure").prop("checked", false);
                            $("#id_filterbarform-infrastructure").change();
                            $("#id_filterbarform-photos").prop("checked", false);
                            $("#id_filterbarform-photos").change();
                            $("#id_filterbarform-all").prop("checked", false);
                            $("#id_filterbarform-all").change();
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-check' }
                            });
                        } else {
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-closethick' }
                            });
                        }});


            // infrastructure icon
            $('#id_filterbarform-infrastructure').button({
                text: true
            }).change(function() {
                        if (!firsttime) {$("#id_filterbarform-submit").addClass('highlight');};
                        if ($(this).is(':checked')){
                            $("#id_filterbarform-buildings").prop("checked", false);
                            $("#id_filterbarform-buildings").change();
                            $("#id_filterbarform-casualty").prop("checked", false);
                            $("#id_filterbarform-casualty").change();
                            $("#id_filterbarform-socioeconomic").prop("checked", false);
                            $("#id_filterbarform-socioeconomic").change();
                            $("#id_filterbarform-photos").prop("checked", false);
                            $("#id_filterbarform-photos").change();
                            $("#id_filterbarform-all").prop("checked", false);
                            $("#id_filterbarform-all").change();
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-check' }
                            });
                        } else {
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-closethick' }
                            });
                        }});


            // photos icon
            $('#id_filterbarform-photos').button({
                text: true
            }).change(function() {
                        if (!firsttime) {$("#id_filterbarform-submit").addClass('highlight');};
                        if ($(this).is(':checked')){
                            $("#id_filterbarform-buildings").prop("checked", false);
                            $("#id_filterbarform-buildings").change();
                            $("#id_filterbarform-casualty").prop("checked", false);
                            $("#id_filterbarform-casualty").change();
                            $("#id_filterbarform-infrastructure").prop("checked", false);
                            $("#id_filterbarform-infrastructure").change();
                            $("#id_filterbarform-socioeconomic").prop("checked", false);
                            $("#id_filterbarform-socioeconomic").change();
                            $("#id_filterbarform-all").prop("checked", false);
                            $("#id_filterbarform-all").change();
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-check' }
                            });
                        } else {
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-closethick' }
                            });
                        }});


            // socioeconomic icon
            $('#id_filterbarform-socioeconomic').button({
                text: true
            }).change(function() {
                        if (!firsttime) {$("#id_filterbarform-submit").addClass('highlight');};
                        if ($(this).is(':checked')){
                            $("#id_filterbarform-buildings").prop("checked", false);
                            $("#id_filterbarform-buildings").change();
                            $("#id_filterbarform-casualty").prop("checked", false);
                            $("#id_filterbarform-casualty").change();
                            $("#id_filterbarform-infrastructure").prop("checked", false);
                            $("#id_filterbarform-infrastructure").change();
                            $("#id_filterbarform-photos").prop("checked", false);
                            $("#id_filterbarform-photos").change();
                            $("#id_filterbarform-all").prop("checked", false);
                            $("#id_filterbarform-all").change();
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-check' }
                            });
                        } else {

                            $(this).button("option", {
                                icons: {primary: 'ui-icon-closethick' }
                            });
                        }});


            // all icon
            $('#id_filterbarform-all').button({
                text: true
            }).change(function() {
                        if (!firsttime) {$("#id_filterbarform-submit").addClass('highlight');};
                        if ($(this).is(':checked')){
                            $("#id_filterbarform-buildings").prop("checked", false);
                            $("#id_filterbarform-buildings").change();
                            $("#id_filterbarform-casualty").prop("checked", false);
                            $("#id_filterbarform-casualty").change();
                            $("#id_filterbarform-infrastructure").prop("checked", false);
                            $("#id_filterbarform-infrastructure").change();
                            $("#id_filterbarform-photos").prop("checked", false);
                            $("#id_filterbarform-photos").change();
                            $("#id_filterbarform-socioeconomic").prop("checked", false);
                            $("#id_filterbarform-socioeconomic").change();
                            //$("#id_filterbarform-buildings").button("option", {disabled:true});
                            //$("#id_filterbarform-casualty").button("option", {disabled:true});
                            //$("#id_filterbarform-infrastructure").button("option", {disabled:true});
                            //$("#id_filterbarform-photos").button("option", {disabled:true});
                            //$("#id_filterbarform-socioeconomic").button("option", {disabled:true});
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-check' }
                            });
                        } else {
                            //$("#id_filterbarform-buildings").button("option", {disabled:false});
                            //$("#id_filterbarform-casualty").button("option", {disabled:false});
                            //$("#id_filterbarform-infrastructure").button("option", {disabled:false});
                            //$("#id_filterbarform-photos").button("option", {disabled:false});
                            //$("#id_filterbarform-socioeconomic").button("option", {disabled:false});
                            $(this).button("option", {
                                icons: {primary: 'ui-icon-closethick' }
                            });
                        }});

            // get buttons to pick up their default values
            $("#id_filterbarform-buildings").change();
            $("#id_filterbarform-casualty").change();
            $("#id_filterbarform-infrastructure").change();
            $("#id_filterbarform-photos").change();
            $("#id_filterbarform-socioeconomic").change();
            $("#id_filterbarform-all").change();


            // apply button
            $('#id_filterbarform-submit').button({
                text:true,
                icons:{primary: 'ui-icon-closethick' }
            });

            // advanced button
            $('#advanced').click(function(event){
                $("#advancedfilterpanel").css("display", "block");
                event.preventDefault();
            });

            // close advanced filter panel button
            $('#closebutton').button({ text:false, icons: { primary: "ui-icon-closethick" } }).click(function(event){
                $("#advancedfilterpanel").css("display", "none");
                event.preventDefault();
            });


            firsttime = false;
        });

        // sliding panel
        jQuery(function($) {
            $(document).ready(function() {
                $('#panelHandle-leg').hover(function() {
                    $('#sidePanel-leg-hazard').stop(true, false).animate({
                        'left': '0px'
                    }, 900);
                }, function() {
                    jQuery.noConflict();
                });

                jQuery('#sidePanel-leg-hazard').hover(function() {
                    // Do nothing
                }, function() {

                    jQuery.noConflict();
                    jQuery('#sidePanel-leg-hazard').animate({
                        left: '-201px'
                    }, 800);

                });
            });
        });

        // The map
        // base layers
        naturalEarth = L.tileLayer('http://{s}.tiles.mapbox.com/v3/mapbox.natural-earth-2/{z}/{x}/{y}.png'),
        GEM_base = L.tileLayer('http://tilestream.openquake.org/v2/world-landmass/{z}/{x}/{y}.png');

        var baselayer = {
            'Natural Earth' : naturalEarth,
            'GEM Base Map' : GEM_base
        };

        // overlay layers

        osm = L.tileLayer('http://{s}.tiles.mapbox.com/v3/mapbox.world-bank-borders-en/{z}/{x}/{y}.png'),

        hazard_map_japan_21 = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-21/{z}/{x}/{y}.png');

        hazard_map_japan_22 = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-22/{z}/{x}/{y}.png');

        hazard_map_japan_22_land = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-22-land/{z}/{x}/{y}.png');

        hazard_map_japan_21_land = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-21-land/{z}/{x}/{y}.png');

        hazard_map_japan_21_contour = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-21-contour/{z}/{x}/{y}.png');

        hazard_map_japan_22_contour = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-22-contour/{z}/{x}/{y}.png');

        hazard_map_japan_21_contour_land = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-21-contour-land/{z}/{x}/{y}.png');

        hazard_map_japan_22_contour_land = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-japan-22-contour-land/{z}/{x}/{y}.png');

        hazard_curve_Japan = L.tileLayer('http://tilestream.openquake.org/v2/hazard-curve-japan/{z}/{x}/{y}.png', {
            wax: 'http://tilestream.openquake.org/v2/hazard-curve-japan.json'
        });

        hazard_curve_Japan_land = L.tileLayer('http://tilestream.openquake.org/v2/hazard-curve-japan-land/{z}/{x}/{y}.png', {
            wax: 'http://193.206.66.82:8000/v2/hazard-curve-japan-land.json'
        });

        hazard_map = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-points-world/{z}/{x}/{y}.png');

        hazard_contour = L.tileLayer('http://tilestream.openquake.org/v2/hazard-map-contour-4/{z}/{x}/{y}.png');

        hazard_curve = L.tileLayer('http://tilestream.openquake.org/v2/hazard-curve-world/{z}/{x}/{y}.png', {
            wax: 'http://tilestream.openquake.org/v2/hazard-curve-world.json'
        });

        grump_rural = L.tileLayer('http://tilestream.openquake.org/v2/gdal-custom-rural/{z}/{x}/{y}.png');

        grump_urban = L.tileLayer('http://tilestream.openquake.org/v2/gdal-custom-urban/{z}/{x}/{y}.png',{opacity: 0.8});

        // GEM ECD specific mapping
        var customIcon = L.icon({
            iconUrl: '{{ STATIC_URL }}marker-icon.png',
            shadowUrl: '{{ STATIC_URL }}marker-shadow.png',
            iconSize:     [12, 20], // size of the icon
            shadowSize:   [20, 20], // size of the shadow
            iconAnchor:   [6, 20], // point of the icon which will correspond to marker's location
            shadowAnchor: [6, 20],  // the same for the shadow
            popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
        });

        var geojsonFeature = {{ geojson|safe }}

                eventsLayer = L.geoJson(geojsonFeature,
                        {
                            pointToLayer: function (feature, latlng)
                            {
                                {% if maptype == 'event' %}
                                    year = parseInt(feature.properties.y);
                                    if (year < 1900)
                                    {
                                        year = year + 100;
                                    }
                                    var mkr =  L.marker(latlng, {icon:customIcon, title:year + " " + feature.properties.n + " " + feature.properties.c });
                                {% endif %}
                                {% if maptype == 'location' %}
                                    var mkr =  L.marker(latlng, {icon:customIcon, title:feature.properties.n + ": " + feature.properties.c + " photo(s)"});
                                {% endif %}

                                mkr.featureID = feature.properties.i;
                                return mkr;
                            },
                            onEachFeature:function (feature, layer)
                            {
                                {% if maptype == 'event' %}
                                    year = parseInt(feature.properties.y);
                                    if (year < 1900)
                                    {
                                        year = year + 100;
                                    }
                                    html = '<span id="eventdate">' + year + '</span><span id="eventname">' + feature.properties.n + '</span><span id="eventcountry">' + feature.properties.c + '</span>';
                                    html = html + '<span id="photocount">' + feature.properties.s + ' study(s)</span>'
                                    html = html + '<a href=/overview?{{ eventquerystring }}&zoomtoextent=True&eventid=' + feature.properties.i + '>Locations on map &raquo;</a>';
                                    //html = html + '<a href=/overview?{{ eventquerystring }}&zoomtoextent=True&eventid=' + feature.properties.i + '&tab=photos>Photos &raquo;</a>';
                                    html = '<div id="eventpopupcontainer">\n' + html + '</div>\n'
                                    layer.bindPopup( html );
                                {% endif %}
                                {% if maptype == 'location' %}
                                    layer.on("click", function(e)
                                            {
                                                var csrftoken = getCookie('csrftoken');
                                                jQuery.ajaxSetup({
                                                    beforeSend: function(xhr, settings)
                                                    {
                                                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                                                    }
                                                });

                                                var post = jQuery.post
                                                (
                                                        "/overview/locationjson?markerid=" + e.target._leaflet_id + "&locationid=" + e.target.featureID,
                                                        function(json)
                                                        {   // callback
                                                            html =        '' + json.eventtitle + '<br />' +
                                                                    '<i>' + json.study + '</i><br />' +
                                                                    '<img src="' + json.photourl + '" /><br />' +
                                                                    '<span id="locationame">' + json.locationname + '</span><br />' +
                                                                    '<b>Inventory class: </b>' + json.inventoryclass + ' (' + json.inventorydescription + ')'+ '<br />' +
                                                                    '<b>Damage level: </b>' + json.damagelevel + '<br />' +
                                                                    '<b>Asset class: </b>' + json.assetclass + '<br />' +
                                                                    '<b>Asset type: </b>' + json.assettype + '<br />' +
                                                                    '<b>Asset subtype: </b>' + json.assetsubtype + '<br />' +
                                                                    '<b>Design code: </b>' + json.designcode + '<br />' +
                                                                    '<a href="/overview?{{ tabsquerystring }}&tab=photos&locationid=' + json.locationid + '">see all ' + json.photocount + ' photo(s) &raquo;</a>' +
                                                                    '<a href="/location/' + json.locationid + '">location details &raquo;</a>';

                                                            html = '<div id="locationpopupcontainer">\n' + html + '</div>\n'

                                                            e.target._layers[json.markerid].bindPopup(html).openPopup();
                                                            jQuery("#id_locationid").val(json.locationid);
                                                            jQuery("#currentlocationname").text(json.locationname);
                                                        }
                                                );
                                            }
                                    );
                                {% endif %}
                            }
                        }
                );

        //end of GEM ECD mapping

        var overlays = {
            "ECD events" : eventsLayer,
            "GRUMP Urban" : grump_urban,
            "GRUMP Rural" : grump_rural,
            "OpenStreetMap" : osm,

            {% if user.is_authenticated %}
            "Japan Hazard Map - 10% in 50 years" : hazard_map_japan_21,
            "Japan Hazard Map - 10% in 50 years - Land" : hazard_map_japan_21_land,
            "Japan Hazard Map - 10% in 50 years - Contour" : hazard_map_japan_21_contour,
            "Japan Hazard Map - 10% in 50 years - Contour - Land" : hazard_map_japan_21_contour_land,
            "Japan Hazard Map - 2% in 50 years" : hazard_map_japan_22,
            "Japan Hazard Map - 2% in 50 years - Land" : hazard_map_japan_22_land,
            "Japan Hazard Map - 2% in 50 years - Contour" : hazard_map_japan_22_contour,
            "Japan Hazard Map - 2% in 50 years - Contour - Land" : hazard_map_japan_22_contour_land,
            "Japan Hazard Curve - PGA" : hazard_curve_Japan,
            "Japan Hazard Curve - PGA - Land" : hazard_curve_Japan_land,
            "World Hazard Map - 10% in 50 years" : hazard_map,
            "World Hazard Map - 10% in 50 years - Contour" : hazard_contour,
            "World Hazard Curve - PGA" : hazard_curve,
             {% endif %}

        };

        // create the map
        var map = L.map('map', {
            center: [20, 20],
            zoom: 2,
            maxZoom: 9,
            layers: [{% if user.is_authenticated %}hazard_map,{% endif %} GEM_base, eventsLayer]
        });

        L.control.layers(baselayer, overlays).addTo(map);

        // Add Wax support
        L.wax(map);




    </script>
    <span id="showGrid"></span>

    {% endif %}

{% endblock main %}

