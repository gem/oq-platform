{% extends "base.html" %}

{% block title %}
{% endblock title %}

{% block extra_head %}
    <link href="{{ STATIC_URL }}css/oqplatform.css" rel="stylesheet"/>
    <link rel="shortcut icon" href="/static/img/favicon.ico"/>

    <!-- Constants, rendered here from app configuration through Django templates.
         This is a simple way to make variables from the backend available to the
         frontend.

         This code is auto-generated.
    -->
    <script type="text/javascript">
        var THIRD_PARTY_URLS = {};
        {% for k, v in third_party_urls.iteritems %}
        THIRD_PARTY_URLS.{{ k }} = "{{ v }}";
        {% endfor %}
        var TS_URL = '{{ tilestream_url }}';
        var BING_KEY = {};
        {% for k, v in bing_key.iteritems %}
        BING_KEY.{{ k }} = "{{ v }}";
        {% endfor %}
        var CURRENT_USER = "{{request.user}}";
    </script>
{% endblock extra_head %}


{% block extra-nav %}
{% include "extra-nav.html" %}
{% endblock extra-nav %}

{% block extra_script %}
    <!--  Override this in child templates to include additional javascript code -->


    <style>
		  /* SVG styling used in GetFeatureInfoTemplate */
			path {
				stroke: steelblue;
				stroke-width: 1;
				fill: none;
			}

			.axis {
			  shape-rendering: crispEdges;
			}

			.axis line {
			  stroke: lightgrey;
			}

			.axis .minor {
			  stroke-opacity: .5;
			}

			.axis path {
			  display: none;
			}
    </style>

    <script src="{{ STATIC_URL }}js/d3.js"></script>

    <script type="text/javascript">
      /* Override addOutput for the getfeatureinfo tool in order to
      parse eventual GetFeatureInfo templates and run javascript
      against them */

      if (typeof(gxp) != 'undefined') {
      var originalAddOutput = gxp.plugins.WMSGetFeatureInfo.prototype.addOutput;
      Ext.override(gxp.plugins.WMSGetFeatureInfo, {
        addOutput: function(config) {
          var width = 300, height = 150, margin = 20;
          config['width'] = width + 2 * margin;
          config['scroll'] = true;
          config['listeners'] = {
            afterlayout: function() {
              jQuery('.curve.to_draw').map(function(i, el) {
                var $el = $(el);

                var x_values = $el.attr('data-x').split(',');
                var poes = $el.attr('data-y').split(',');

                var canvas = d3.select(el).append('svg:svg')
                                            .attr("width", width + 2 * margin)
                                            .attr("height", height + 2 * margin)
                                            .append("svg:g")
                                            .attr("transform", "translate(" + margin + "," + margin + ")");
                var x = d3.scale.linear().domain([0, d3.max(x_values)]).range([0, width]);
                var y = d3.scale.linear().domain([0, 1]).range([height, 0]);
                var line = d3.svg.line().x(function(d, i) { return x(i) }).y(function(d, i) { return y(d) });
                var xAxis = d3.svg.axis().scale(x).tickSize(-height).tickSubdivide(true);
                canvas.append("svg:g").attr("class", "axis").attr("transform", "translate(0, " + height  + ")").call(xAxis);
                var yAxis = d3.svg.axis().scale(y).tickSize(width).tickSubdivide(true).orient("left");
                canvas.append("svg:g").attr("class", "axis").attr("transform", "translate(" + width + " , 0)").call(yAxis);
                canvas.append("svg:path").attr("d", line(poes));
                $el.removeClass('to_draw');
                $el.show();
             });
            }
          };
          return originalAddOutput.apply(this, [config]);
        }});
      }
    </script>
{% endblock extra_script %}
