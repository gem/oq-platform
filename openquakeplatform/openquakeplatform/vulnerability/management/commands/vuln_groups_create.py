# Copyright (c) 2012-2014, GEM Foundation.
#
# This program is free software: you can redistribute it and/or modify
# under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

from django.core.management.base import BaseCommand
from django.db.models import signals
from django.contrib.auth.models import Group, Permission, ContentType

class Command(BaseCommand):
    help = 'Create groups for vulnerability app'

    def handle(self, *args, **options):

        #
        print "### vulnerability-admins group creation ###"
        #
        role, created = Group.objects.get_or_create(name="vulnerability-admins")
        if not role:
            print "vulneralbility-admins group retrieve failed"
            return

        for c in ContentType.objects.filter(app_label = 'vulnerability'):
            print "ContentType: name [%s]  app_label [%s]  model [%s]" % (c.name, c.app_label, c.model)

            for p in Permission.objects.filter(content_type_id = c.id):
                print "  Permission: codename [%s]" % (p.codename,)
                gp = role.permissions.add(p)

                
        #
        print "--------------------------------------------"
        print "### vulnerability-editors group creation ###"
        #
        role, created = Group.objects.get_or_create(name="vulnerability-editors")
        if not role:
            print "vulneralbility-editors group retrieve failed"
            return

        for c in ContentType.objects.filter(app_label = 'vulnerability'):
            print "ContentType: name [%s]  app_label [%s]  model [%s]" % (c.name, c.app_label, c.model)

            # the country will not be editable by editors users
            if c.model == "country":
                print "country model permissions not assigned"
                continue

            for p in Permission.objects.filter(content_type_id = c.id):
                print "  Permission: codename [%s]" % (p.codename,)
                gp = role.permissions.add(p)

