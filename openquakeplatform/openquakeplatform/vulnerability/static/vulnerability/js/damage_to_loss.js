/*
   Copyright (c) 2015, GEM Foundation.

      This program is free software: you can redistribute it and/or modify
      it under the terms of the GNU Affero General Public License as
      published by the Free Software Foundation, either version 3 of the
      License, or (at your option) any later version.

      This program is distributed in the hope that it will be useful,
      but WITHOUT ANY WARRANTY; without even the implied warranty of
      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
      GNU Affero General Public License for more details.

      You should have received a copy of the GNU Affero General Public License
      along with this program.  If not, see <https://www.gnu.org/licenses/agpl.html>.
*/

/////////////////////////////////
//////// Jquery Stuff ///////////
/////////////////////////////////

// Remove GeoNode artifact
$(".span12").remove();

$(function() {
    $("#accordion").accordion({
        collapsible: true,
        heightStyle: "content"
    });
});

/////////////////////////////////
/// Create Damage Metadata //////
/////////////////////////////////

var respVar = gl.fields.damage_to_loss_func.fields.resp_var;
var assessmentType = gl.fields.type_of_assessment;
var dlName = gl.fields.name;
var publication = gl.fields.publication_conference_name;
var articleTitle = gl.fields.article_title;
var authors = gl.fields.authors;
var year = gl.fields.year;
var method = gl.fields.damage_to_loss_func.fields.method_of_estimation;
var category = gl.fields.category;

// Manage long function names
var dlNameLength = dlName.length;
var dlName1 = dlName;
var dlName2 = null;
if (dlNameLength > 50) {
    // Split the dltion name into two
    var dlNameArray = dlName.replace(/.{50}\S*\s+/g, "$&@").split(/\s+@/);
    dlName1 = dlNameArray[0];
    dlName2 = dlNameArray[1];
}

// Check if the variables are defined in the database
// and add them to the information dialog
// and do nothing if the information is not available in the database
try {
    var structureType = gl.fields.structure_type;
}
catch(e) {
    var structureType = '';
}

try {
    var taxText = gl.fields.taxonomy_text;
}
catch(e) {
    // Continue
}

try {
    var taxType = gl.fields.taxonomy_type.fields.name;
}
catch(e) {
    // Continue
}

try {
    var generalComments = gl.fields.general_comments;
    generalComments = escapeHtml(generalComments);
}
catch(e) {
    // Continue
}

try {
    var useCase = gl.fields.use_case_information;
}
catch(e) {
    // Continue
}

var GeoError;
try {
    var geoApp = gl.fields.geo_applicability.fields.countries;
    var geoArea = gl.fields.geo_applicability.fields.area;
    GeoError = false;
}
catch(e) {
    GeoError = true;
}

if (GeoError === false) {
   var countriesArray = [];

    for (var i = geoApp.length - 1; i >= 0; i--) {
        var tmp = " "+geoApp[i].fields.name;
        countriesArray.push(tmp);
    }
}

function is_set(a) {
    return (a !== undefined && a !== "" && a !== null);
}

if (is_set(assessmentType)) {
    $("#genInfo").append('<p><b>Assessment Type: </b>'+assessmentType+'</p>');
}

if (is_set(respVar)) {
    $("#genInfo").append('<p><b>Response Variable: </b>'+respVar+'</p>');
}

if (is_set(dlName)) {
    dlName = dlName.replace(/_/g, ' ');
    $("#genInfo").append('<p><b>Name: </b>'+dlName+'</p>');
}

if (is_set(category)) {
    $("#genInfo").append('<p><b>Category: </b>'+category+' - '+structureType+'</p>');
}

if (is_set(taxText)) {
    $("#genInfo").append('<p><b>Taxonomy: </b>'+taxText+' ('+taxType+')</p>');
}

if (is_set(articleTitle)) {
    $("#genInfo").append('<p><b>Reference: </b>'+articleTitle+' ('+authors+', '+year+') - '+publication+'</p>');
}

if (gl.fields.web_link !== undefined && gl.fields.web_link !== "") {
    var webLink = gl.fields.web_link;
    $("#genInfo").append('<p><b>Web Link: </b><a style="color:blue" href="'+webLink+'" target="_blank"> '+webLink+'</a></p>');
}

if (is_set(geoApp)) {
    $("#genInfo").append('<p><b>Geographical Applicability: </b>'+countriesArray+'</p>');
}

if (geoArea !== undefined && geoArea !== "" && geoArea !== null) {
    $("#genInfo").append('<p><b>Geographical Area: </b>'+geoArea+'</p>');
}

if (is_set(method)) {
    $("#genInfo").append('<p><b>Methodology: </b>'+method+'</p>');
}

if (is_set(generalComments)) {
    $("#genInfo").append('<p><b>General Comments: </b>'+generalComments+'</p>');
}

if (is_set(useCase)) {
    $("#genInfo").append('<p><b>Use Case Information: </b>'+useCase+'</p>');
}

/////////////////////////////////
////// Create Damage Curves /////
/////////////////////////////////

var meanDamage = gl.fields.damage_to_loss_func.fields.func_distr_dtl_discr.fields.var_mean_val;
meanDamage = meanDamage.split(";");

var coeff = gl.fields.damage_to_loss_func.fields.func_distr_dtl_discr.fields.var_val_coeff;
coeff = coeff.split(";");

var limitStates = gl.fields.damage_to_loss_func.fields.limit_states_desc;
limitStates = limitStates.split(";");

var chartData = [];

for (var i = 0; i < limitStates.length; i++) {
    var dataObj = {};
    dataObj["mean"] = parseFloat(meanDamage[i]);
    dataObj["name"] = limitStates[i];
    chartData.push(dataObj);
}

buildMixedD3Chart(chartData);
damage2LossTable();

/////////////////////////////////
///// Damage Data Table /////////
/////////////////////////////////

function damage2LossTable() {
    var aaData = [];
    var funcDisShape;
    try {
        funcDisShape = gl.fields.damage_to_loss_func.fields.func_distr_dtl_discr.fields.func_distr_shape;
    } catch (e) {
        // continue
    }
    if (funcDisShape === null) {
        funcDisShape = "not available";
    }

    for (var i = 0; i < limitStates.length; i++) {
        var tmp = [];
        tmp.push(limitStates[i]);
        tmp.push(meanDamage[i]);
        if (coeff.length > 1) {
            tmp.push(coeff[i]);
        }

        aaData.push(tmp);
    }

    var columnLS = {"sTitle": "Limit State"};
    var columnMean = {"sTitle": "Mean loss ratio"};
    var columnCoef = {"sTitle": "CoV"};
    var alColumns = [];

    alColumns.push(columnLS);
    alColumns.push(columnMean);

    if (coeff.length > 1) {
        alColumns.push(columnCoef);
    }

    if (coeff.length > 1) {
        $('#function-table').append(
            '<thead id="tablehead">'+
                '<tr>'+
                    '<th colspan="2">Uncertainty Distribution: '+funcDisShape+'</th>'+
                '</tr>'+
                '<tr>'+
                    '<th>Limit State</th>'+
                    '<th>Mean loss ratio</th>'+
                    '<th>CoV</th>'+
                '</tr>'+
            '</thead>'+
            '<tbody id="tableBody">'+
                '<tr><td>'+
                '</td></tr>'+
            '</tbody>'
        );
    } else {
        $('#function-table').append(
            '<thead id="tablehead">'+
                '<tr>'+
                    '<th colspan="2">Uncertainty Distribution: '+funcDisShape+'</th>'+
                '</tr>'+
                '<tr>'+
                    '<th>Limit State</th>'+
                    '<th>Mean loss ratio</th>'+
                '</tr>'+
            '</thead>'+
            '<tbody id="tableBody">'+
                '<tr><td>'+
                '</td></tr>'+
            '</tbody>'
        );
    }

    $('#function-table').dataTable({
        "aaSorting": [[1, 'asc']],
        "aaData": aaData,
        "aoColumns": alColumns,
        "bLengthChange": false,
        "bFilter": false,
        "bPaginate": false,
        "bInfo": false,
        "bSort": false,
    });
}


/////////////////////////////////////////////
///////////// Damage to loss Chart //////////
/////////////////////////////////////////////

function buildMixedD3Chart(chartData) {

    dlName = dlName.replace(/_/g, ' ');

    var margin = {top: 60, right: 20, bottom: 50, left: 60},
        width = 480 - margin.left - margin.right,
        height = 440 - margin.top - margin.bottom;

    var x0 = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);

    var x1 = d3.scale.ordinal();

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.ordinal()
        .range(["#98abc5", "#8a89a6"]);

    var xAxis = d3.svg.axis()
        .scale(x0)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .tickFormat(d3.format(".2r"));

    var svg = d3.select("#functionChart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var data = chartData;

    var ageNames = d3.keys(data[0]).filter(function(key) { return key !== "name"; });

    data.forEach(function(d) {
      d.ages = ageNames.map(function(name) { return {name: name, value: +d[name]}; });
    });

    x0.domain(data.map(function(d) { return d.name; }));
    x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);
    y.domain([0, d3.max(data, function(d) { return d3.max(d.ages, function(d) { return d.value; }); })]);

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .append("text")
        .attr("y", 30)
        .attr("x", 225)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .style("font-weight", "bold")
        .text("Damage State");

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -55)
        .attr("x", -90)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .style("font-weight", "bold")
        .attr("font-size","14px")
        .text(respVar);

    var name = svg.selectAll(".name")
        .data(data)
      .enter().append("g")
        .attr("class", "g")
        .attr("transform", function(d) { return "translate(" + x0(d.name) + ",0)"; });

    name.selectAll("rect")
        .data(function(d) { return d.ages; })
      .enter().append("rect")
        .attr("width", 35)
        .attr("x", function(d) { return (x1(d.name)+25); })
        .attr("y", function(d) { return y(d.value); })
        .attr("height", function(d) { return height - y(d.value); })
        .style("fill", function(d) { return color(d.name); });

     textTopLable = svg.append("text")
        .attr("x", 0)
        .attr("y", -35)
        .attr("dy", ".35em")
        .style("font-weight", "bold")
        .attr("font-size","14px")
        .text(assessmentType+ ' ' +dlName1);

    if (dlName2 !== null) {
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", -15)
            .attr("dy", ".35em")
            .style("font-weight", "bold")
            .style("text-anchor", "middle")
            .style("font-size"," 14px")
            .text(dlName2);
    }

    var legend = svg.selectAll(".legend")
        .data(ageNames.slice().reverse())
      .enter().append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

} // End Chart

