{% extends "site_base.html" %}
{% load i18n %}

{% block title %} {% trans page_title %} {% endblock title %}
{% block indexclass %} class="here" {% endblock indexclass %}
{% block body_class %}bodyclass{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ STATIC_URL }}css/d3.css" />
<link rel="stylesheet" href="{{ STATIC_URL }}vulnerability/css/vulnerability.css" />
<script src="{{ STATIC_URL }}js/d3.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="{{ STATIC_URL }}js/utility.js"></script>
<script type="text/javascript"><!--
var global_id = {% if curve_id == "" %}null{% else %}{{ curve_id }}{% endif %};
var gl;
function entry_select(id) {
    global_id = id;
    $("[id='first_step']").css("display", "none");
    $("[id='actions']").css("display", "block");
    $("[id^='list_entry-']").removeClass("list_entry_selected");
    $("[id='list_entry-"+id+"']").addClass("list_entry_selected");
}

function empty_check(obj) {
    var strconfirm = confirm("Empty cart: are you sure ?");

    if (strconfirm == true) {
        obj.form.action = '/vulnerability/cart/empty';
        return true;
    }

    return false;
}

//-->
</script>
<style>
body.bodyclass { height: 100%; }

div.liquid_content {
    position: relative;
    width: 100%;
    background-color: #ffddff;
}

div.list_func_container {
    position: relative;
    display: inline;
    float: left;
    width: 25%;
    background-color: #f3f0ef;
    overflow: auto;
    border: 0px solid grey;
    border-left: 0px;
}

div.preview_container {
    position: relative;
    display: inline;
    float: left;
    width: 75%;
    background-color: #ffffff;
    border: 0px solid grey;
    border-right: 0px;
}

div.preview {
    border: 1px solid gray;
    border-right:  0px;
    border-bottom: 0px;
    overflow: auto;
}

div.list_func {
    padding: 8px;
    border-top: 1px solid gray;
}

div.list_entry {
    color: #1b75a7;
    cursor: pointer;
}

div.list_entry:hover {
    text-decoration: underline;
}

div.list_entry_selected {
    background-color: white;
    color: black;
}

div.list_entry_selected:hover {
    background-color: white;
    color: black;
}

ul.vuln_menu
{
    width: 100%;
    margin: 0;
    list-style-type: none;
    background-color: #f3f0ef;
    background-position: left bottom;
    border-bottom: 1px solid #1b75a7;
}

li.vuln_menu {
    display: inline-block;
    color: black;
    padding: 0 8px 0 8px;
    font-size: 14px;
    line-height: 32px;
    vertical-align: bottom;
}

li.vuln_menu_selected {
    background-color: #ffffff;
    border: 1px solid #1b75a7;
    line-height: 30px;
    border-bottom: 1px solid white;
}

li.vuln_menu_grey {
    color: grey;
}

li.vuln_menu_title {
    background-color: rgb(27, 117, 167);
    color: white;
    font-size: 16px;
    font-weight: bold;
}

li.vuln_menu_button {
    color: black;
    margin: 0px;
}


a.vuln_menu
{
    width:6em;
    color: #1b75a7;
    padding:0.2em 0.6em;
}

a.vuln_menu:hover {
    text-decoration:underline;
}

input, textarea, .uneditable-input {
    width: 150px;
}

select {
    width: auto;
}

/* messages */
<ul
ul.messagelist {
    margin: 0;
    padding: 0;
}

ul.messagelist li {
    background: url("/static/admin/img/icon_success.gif") no-repeat scroll 5px 0.3em #ffc;
    border-bottom: 1px solid #ddd;
    color: #666;
    display: block;
    font-size: 12px;
    margin: 0;
    padding: 4px 5px 4px 25px;
    list-style-type: square;
    line-height: 18px;
}

</style>
{{ block.super }}
{% endblock %}

{% block middle %}
  <div id="oq-page-middle">
    <div>
    {% block messages %}
        {% if messages %}
      <div><ul class="messagelist">
            {% for message in messages %}
        <li {%     if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
      </div>
        {% endif %}
    {% endblock messages %}
    </div>
    <div class="main">
      <ul class="vuln_menu">
        <li class="vuln_menu vuln_menu_first vuln_menu_title">Cart: collection of curves to export as a single NRML file.</li>
        {% for toa_key,toa_value in types_of_assessment.items %}{% if toa_key == type_of_assessment %}<li class="vuln_menu vuln_menu_selected">{{toa_value}}</li>{% else %}<li class="vuln_menu vuln_menu_grey">{{toa_value}}</li>{% endif %}{% endfor %}
        <li class="vuln_menu vuln_menu_button">
          <form action="" method="post" style="margin: 0px 0px 0px 0px; padding: 0px;">
            <input type="hidden" name="type_of_assessment" value="{{ type_of_assessment }}">
            <input type="hidden" id="curve_id" name="curve_id" value="{{ curve_id }}">
            <button type="submit" value="List" title="Go to curves list" alt="Go to curves list" onclick="this.form.action = '/vulnerability/list';"><i class="icon-list"></i>List</button>
          </form>
        </li>
        {% if geninfo %}
        <li class="vuln_menu vuln_menu_button" style="float: right;">
          <form action="" method="post" style="margin: 0; padding: 0px;">
            <input type="hidden" name="action" value="">
            <button style="margin-right: 8px;" type="submit" value="Export as NRML" title="Export curves of cart as NRML" alt="Export curves of cart as NRML" onclick="this.form.action = '/vulnerability/cart/export-as-nrml';"><i class="icon-download-alt"></i>Export as NRML</button>
          </form>
        </li>
        <li class="vuln_menu vuln_menu_button" style="float: right;">
          <form action="" method="post" style="margin: 0; padding: 0px;">
            <button type="submit" value="Empty cart" title="Empty cart" alt="Empty cart" onclick="return empty_check(this);"><i class="icon-trash"></i>Empty cart</button>
          </form>
        </li>
        {% endif %}
      </ul>
      <div class="liquid_content">
        <div id="list_func_container" class="list_func_container">
          <div id="list_func" class="list_func">
            <!-- Geninfo  -->
            {% for gi_cur in geninfo %}
            <div id="list_entry-{{ gi_cur.id }}" class="list_entry" onclick="entry_select({{ gi_cur.id }});">{{ gi_cur }}</div>
            {% endfor %}
          </div>
        </div>
      <div id="preview_container" class="preview_container">
        <div id="preview" class="preview">
          {% if geninfo %}<p id="first_step" style="font-size: 24px; text-align: center; margin-top: 100px;">Select a list item on the left.</p>{% else %}
          <p id="first_step" style="font-size: 24px; text-align: center; margin-top: 100px;">Cart is empty.</p>
          {% endif %}
          <div id="actions" style="display: none;">
            <form action="" method="post" style="margin: 8px;">
            <input id="from" type="hidden" name="from"/>            
            <button type="submit" id="more_details" type="submit" value="More details" title="See more details" alt="See more details" name="_show" onclick="return more_details_cb(this);"><span class="icon-search" aria-hidden="true"></span> More details</button>
            </form>
          </div>
          <div id="functionContainer" class="main_app">
          </div>
        </div>
      </div>
    </div> <!-- div class="main" -->
  </div>
  <script type="text/javascript">

  function manage_list_click() {
        $('.list_entry').off('click');

        $("#curve_id").val(global_id);
        // Get the JSON object
        $.getJSON('{{STATIC}}/vulnerability/data/' + global_id + '/', function (data) {
            gl = jQuery.parseJSON(data);
            var functionType = gl.fields.type_of_assessment;

            $('#functionContainer').empty();
            $('#functionContainer').append('<div id="functionChart"></div>')
            if (functionType == "Fragility") {
                $.getScript("{{ STATIC_URL }}vulnerability/js/fragility_curves.js", function(){
                });
            }
            else if (functionType == "Vulnerability") {
                $.getScript("{{ STATIC_URL }}vulnerability/js/vulnerability_curves.js", function(){
                });
            }
            else if (functionType == "Capacity curve") {
                $.getScript("{{ STATIC_URL }}vulnerability/js/capacity_curves.js", function(){
                });
            }
            else if (functionType == "Damage-to-loss") {
                $.getScript("{{ STATIC_URL }}vulnerability/js/damage_to_loss.js", function(){
                });
            }
            $('.list_entry').click(manage_list_click);
        });
    }

    $('.list_entry').click(manage_list_click);


    function list_resize() {
        /* window_height - starting_h_point_of_container - footer_height - 1(border pixel) - 16(internal padding space) */
        var new_h = $(window).height() - $('#list_func_container').offset().top - $('#footer').height() - 1 - 16;
        $('#list_func').height(new_h);
    }

    function preview_resize() {
        /* window_height - starting_h_point_of_container - footer_height - 1(border pixel) */
        var new_h = $(window).height() - $('#preview_container').offset().top - $('#footer').height() - 1;
        $('#preview').height(new_h);
    }

function more_details_cb(obj) {
        if (global_id != null) {

            obj.form.action = '/vulnerability/view/' + global_id + '/';
            var from = $(obj.form).children("#from")
            from.val("cart")
            obj.form.submit()
            }
        return false;
    }

window.onload = function () {
        list_resize();
        preview_resize();
        $(window).resize(list_resize);
        $(window).resize(preview_resize);
        if (global_id != null) {
            entry_select(global_id);
            manage_list_click();
        }
    }
    </script>

{% endblock %}
