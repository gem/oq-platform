var g_type_of_assessment = {{ type_of_assessment }};

function manage_list_click() {
    $('.list_entry').off('click');
    
    $("#curve_id").val(global_id);
    $("#permalink").attr("href", $(location).attr('href').split('?')[0] + '?type_of_assessment=' +
                         {{ type_of_assessment }} + '&curve_id=' + global_id);
    // Get the JSON object
    $.getJSON('{{STATIC}}/vulnerability/data/' + global_id + '/', function (data) {
        gl = data;
        var functionType = gl.fields.type_of_assessment;
        
        $('#functionContainer').empty();
        $('#functionContainer').append('<div id="functionChart"></div>')
        if (functionType == "Fragility") {
            $.getScript("{{ STATIC_URL }}vulnerability/js/fragility_curves.js", function(){
            });
        }
        else if (functionType == "Vulnerability") {
            $.getScript("{{ STATIC_URL }}vulnerability/js/vulnerability_curves.js", function(){
            });
        }
        else if (functionType == "Capacity curve") {
            $.getScript("{{ STATIC_URL }}vulnerability/js/capacity_curves.js", function(){
            });
        }
        else if (functionType == "Damage-to-loss") {
            $.getScript("{{ STATIC_URL }}vulnerability/js/damage_to_loss.js", function(){
            });
        }
        $('.list_entry').click(manage_list_click);
    });
}

$('.list_entry').click(manage_list_click);


function list_resize() {
    /* window_height - starting_h_point_of_container - footer_height - 1(border pixel) - 16(internal padding space) */
    var new_h = $(window).height() - $('#list_func_container').offset().top - $('#footer').height() - 1 - 16;
    $('#list_func').height(new_h);
}

function preview_resize() {
    /* window_height - starting_h_point_of_container - footer_height - 1(border pixel) */
    var new_h = $(window).height() - $('#preview_container').offset().top - $('#footer').height() - 1;
    $('#preview').height(new_h);
}

function more_details_cb(obj) {
    if (global_id != null) {
        
        obj.form.action = '/vulnerability/view/' + global_id;
        var from = $(obj.form).children("#from")
        from.val("list")
        obj.form.submit()
    }
    return false;
}

function stateful_filters_update_cb() {
    console.log('filter storing here: ' + g_type_of_assessment);
    return(false);
}

function stateful_filters_manager() {
    console.log('stateful_filters_manager: begin');
    $('form[name="filter"]').submit(stateful_filters_update_cb);
// submit(stateful_filters_update_cb);
}

window.onload = function () {
    list_resize();
    preview_resize();
    stateful_filters_manager();
    $(window).resize(list_resize);
    $(window).resize(preview_resize);
    if (global_id != null) {
        entry_select(global_id);
        manage_list_click();
    }
}
    
