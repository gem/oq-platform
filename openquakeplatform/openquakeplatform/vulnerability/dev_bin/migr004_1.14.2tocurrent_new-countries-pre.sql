BEGIN
-- add the new fk field
ALTER TABLE vulnerability_geoapplicability_countries ADD COLUMN country_iso3 character varying(3) ;
-- set the new fk field with the right value
UPDATE vulnerability_geoapplicability_countries SET country_iso3 = vulnerability_country.iso3 FROM vulnerability_country WHERE vulnerability_country.id  = vulnerability_geoapplicability_countries.id;

-- drop the old fk constraint
ALTER TABLE vulnerability_geoapplicability_countries DROP CONSTRAINT vulnerability_geoapplicability_countries_country_id_fkey;

-- drop the old primary key
ALTER TABLE vulnerability_country DROP constraint vulnerability_country_pkey;

-- mirror line --

-- add the new primary key
ALTER TABLE vulnerability_country ADD PRIMARY KEY(iso3);

-- create the new fk constraint
ALTER TABLE vulnerability_geoapplicability_countries ADD CONSTRAINT vulnerability_geoapplicability_countries_country_id_fkey  FOREIGN KEY (country_iso3) REFERENCES vulnerability_country(iso3) DEFERRABLE INITIALLY DEFERRED;

-- drop the old fk field
ALTER TABLE vulnerability_geoapplicability_countries DROP COLUMN country_id;

-- rename the new column with the old fk field name
ALTER TABLE vulnerability_geoapplicability_countries RENAME COLUMN country_iso3 TO country_id;
COMMIT