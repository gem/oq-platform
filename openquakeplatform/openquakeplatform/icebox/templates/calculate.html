{% extends "site_base.html" %}

{% block title %}
Calculate - {{block.super}}
{% endblock title %}

{% block extra_head %}
{{block.super}}
    <link href="{{ STATIC_URL }}/bootstrap/css/bootstrap.css" rel="stylesheet"/>

    <link href="{{ STATIC_URL }}/bootstrap-extend/css/jasny-bootstrap.min.css" rel="stylesheet"/>

{% endblock %}

{% block body %}
<div class="tabbable well-large">
  <ul class="nav nav-tabs">
    <li class="active"><a href="#tab1" data-toggle="tab">Hazard</a></li>
    <li><a href="#tab2" data-toggle="tab">Risk</a></li>
    <li><a href="#tab3" data-toggle="tab">My Calculations</a></li>
    <li><a href="#tab4" data-toggle="tab">My Outputs</a></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane active" id="tab1">
      <div class="well">
        <form class="calc-form" enctype="multipart/form-data"
              method="post" action="{{OQ_ENGINE_SERVER_URLS.run_hazard_calc_form}}">
          <fieldset>
            <legend>Load input files</legend>
            
            <div class="fileinput fileinput-new" data-provides="fileinput">
              <span class="btn btn-default btn-file"><span class="fileinput-new">Select Input Files</span><span class="fileinput-exists">Change</span><input multiple type="file" name="job_config"/></span>
              <span class="fileinput-filename"></span>
              <a href="#" class="close fileinput-exists" data-dismiss="fileinput" style="float: none">&times;</a>
            </div>

            <input type="hidden" name="callback_url" value=""/>
            <input type="hidden" name="foreign_calculation_id" value=""/>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Submit</button>
            </div>
          </fieldset>
        </form>
      </div>
    </div>

    <div class="tab-pane" id="tab2">
      <div class="well">
        <form class="calc-form" enctype="multipart/form-data"
              method="post" action="{{OQ_ENGINE_SERVER_URLS.run_risk_calc_form}}">
          <fieldset>
            <legend>Load input files</legend>
            
            <div class="fileinput fileinput-new" data-provides="fileinput">
              <span class="btn btn-default btn-file"><span class="fileinput-new">Select Input Files</span><span class="fileinput-exists">Change</span><input multiple type="file" name="job_config"/></span>
              <span class="fileinput-filename"></span>
              <a href="#" class="close fileinput-exists" data-dismiss="fileinput" style="float: none">&times;</a>
            </div>

            <label>Hazard Calculation ID</label>
            <input type="text" name="hazard_calculation_id"/>

            <label>Hazard Output ID</label>
            <input type="text" name="hazard_output_id"/>

            <input type="hidden" name="callback_url" value=""/>
            <input type="hidden" name="foreign_calculation_id" value=""/>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Submit</button>
            </div>
          </fieldset>
        </form>
      </div>
    </div>

    <div class="tab-pane well" id="tab3"></div>
    <div class="tab-pane well" id="tab4"></div>
  </div>
</div>

{% endblock body %}

{% block extra_script %}
    <script src="{{ STATIC_URL }}lib/jquery-ui/js/jquery-ui-1.10.3.custom.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}bootstrap-extend/js/jasny-bootstrap.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/underscore-min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/backbone-min.js"></script>

<script type="text/template" id="calculation-table-template">
  <table id="calculation_table" class="table table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Type</th>
        <th>Description</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <% _.each(calculations, function(calc) { %>
      <tr class="<%= calc.get('status') == 'complete' ? 'success' : 'warning' %>">
        <td><%= calc.get('engine_id') || 'Loading...' %></td>
        <td><%= calc.get('calculation_type') %></td>
        <td><%= calc.get('description') %></td>
        <td><%= calc.get('status') %></td>
        <td>
          <% if(calc.get('map')) { %>
            <a href="/maps/<%= calc.get('map') %>" class="btn btn-success">Open</a>

            <% if(calc.get('calculation_type') == 'hazard') { %>
              <a href="#" class="btn btn-primary">Run Risk</a>
            <% } %>
          <% } %>

          <a href="#" data-calc-id="<%= calc.get('id') %>" class="btn btn-danger">Remove</a>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</script>


<script type="text/template" id="output-table-template">
  <table id="output_table" class="table table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Calculation ID</th>
        <th>Description</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <% _.each(outputs, function(out) { %>
      <tr>
        <td><%= out.get('engine_id') %></td>
        <td><%= out.get('calculation') %></td>
        <td><%= out.get('display_name') || 'Loading...' %></td>
        <td>
          <% if(out.get('layer')) { %>
            <a href="/layers/<%= out.get('layer') %>" class="btn btn-success">Open</a>
          <% } %>
          <% if(out.calc().get('calculation_type') == 'hazard') { %>
          <a href="#" class="btn btn-primary">Run Risk</a>
          <% } %>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</script>


<script src="{{ STATIC_URL }}js/jquery.form-3.44.0.js"></script>
<script src="{{ STATIC_URL }}icebox/calculate.js"></script>
{% endblock extra_script %}
